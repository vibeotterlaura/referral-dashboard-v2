<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Referral Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; color: white; margin-bottom: 40px; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .dashboard { background: white; border-radius: 20px; padding: 40px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .login-section { max-width: 400px; margin: 0 auto; }
        .tabs { display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 2px solid #e0e0e0; flex-wrap: wrap; }
        .tab { padding: 15px 25px; background: none; border: none; font-size: 16px; cursor: pointer; color: #666; border-bottom: 3px solid transparent; transition: all 0.3s; }
        .tab.active { color: #667eea; border-bottom-color: #667eea; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 15px; }
        .stat-card h3 { font-size: 14px; opacity: 0.9; margin-bottom: 10px; text-transform: uppercase; }
        .stat-card .value { font-size: 36px; font-weight: bold; }
        .code-section { background: #f8f9fa; padding: 30px; border-radius: 15px; margin-bottom: 30px; }
        .code-display { display: flex; align-items: center; gap: 15px; margin-top: 20px; flex-wrap: wrap; }
        .code { flex: 1; min-width: 200px; background: white; padding: 20px; border-radius: 10px; font-size: 28px; font-weight: bold; text-align: center; border: 3px solid #667eea; color: #667eea; letter-spacing: 2px; }
        .btn { padding: 15px 30px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5568d3; transform: translateY(-2px); }
        .btn-success { background: #48bb78; color: white; }
        .btn-success:hover { background: #38a169; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; font-family: inherit; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #667eea; }
        .link-box { background: white; padding: 15px; border-radius: 8px; display: flex; align-items: center; gap: 10px; margin-top: 15px; }
        .link-box input { flex: 1; border: none; background: transparent; padding: 5px; font-size: 14px; }
        .table-container { overflow-x: auto; margin-top: 20px; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { padding: 15px; text-align: left; border-bottom: 1px solid #e0e0e0; }
        .data-table th { background: #f8f9fa; font-weight: 600; color: #333; }
        .status-badge { padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; display: inline-block; }
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-paid { background: #d1fae5; color: #065f46; }
        .alert { padding: 15px 20px; border-radius: 10px; margin-bottom: 20px; }
        .alert-success { background: #d1fae5; color: #065f46; border-left: 4px solid #10b981; }
        .alert-info { background: #dbeafe; color: #1e40af; border-left: 4px solid #3b82f6; }
        .alert-warning { background: #fef3c7; color: #92400e; border-left: 4px solid #f59e0b; }
        .hidden { display: none; }
        .payout-card { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 15px; }
        .payout-amount { font-size: 32px; font-weight: bold; color: #667eea; margin: 10px 0; }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>üéÅ Referral Dashboard</h1>
        <p>Share, Earn, Get Paid!</p>
    </div>

    <div class="dashboard">
        <div id="loginSection" class="login-section">
            <h2 style="margin-bottom: 20px; text-align: center;">Sign In</h2>
            <div class="form-group">
                <label>Your Email</label>
                <input type="email" id="userEmail" placeholder="email@example.com">
            </div>
            <div class="form-group">
                <label>Referral Code (optional)</label>
                <input type="text" id="existingCode" placeholder="REFER123">
            </div>
            <button class="btn btn-primary" style="width: 100%;" onclick="login()">Access Dashboard</button>
            <p style="margin-top: 15px; text-align: center; color: #666; font-size: 14px;">
                Don't have a code? One will be created!
            </p>
        </div>

        <div id="mainDashboard" class="hidden">
            <div class="tabs">
                <button class="tab active" onclick="switchTab(event, 'overview')">Overview</button>
                <button class="tab" onclick="switchTab(event, 'payouts')">Payouts</button>
                <button class="tab" onclick="switchTab(event, 'nonprofit')">Non-Profit</button>
                <button class="tab" onclick="switchTab(event, 'admin')">Admin</button>
                <!-- NEW -->
                <button class="tab" onclick="switchTab(event, 'intakeq')">IntakeQ</button>
            </div>

            <div id="overview" class="tab-content active">
                <div class="stats-grid">
                    <div class="stat-card"><h3>Clicks</h3><div class="value" id="totalClicks">0</div></div>
                    <div class="stat-card"><h3>Sales</h3><div class="value" id="totalSales">0</div></div>
                    <div class="stat-card"><h3>Earned</h3><div class="value" id="totalEarned">$0</div></div>
                    <div class="stat-card"><h3>Balance</h3><div class="value" id="availableBalance">$0</div></div>
                </div>

                <div class="code-section">
                    <h2>Your Referral Code</h2>
                    <div class="code-display">
                        <div class="code" id="userCode">LOADING</div>
                        <button class="btn btn-primary" onclick="copyCode()">üìã Copy</button>
                    </div>
                    <div class="link-box">
                        <input type="text" id="referralLink" readonly>
                        <button class="btn btn-success" onclick="copyLink()">Copy Link</button>
                    </div>
                    <div style="margin-top: 20px; padding: 15px; background: #e0e7ff; border-radius: 8px;">
                        <strong>üí° How it works:</strong>
                        <ul style="margin: 10px 0 0 20px; line-height: 1.8;">
                            <li>They get <strong id="customerDiscount">10%</strong> off</li>
                            <li>You earn <strong id="commissionRate">10%</strong> commission</li>
                        </ul>
                    </div>
                </div>

                <h3>Recent Activity</h3>
                <div class="table-container">
                    <table class="data-table">
                        <thead><tr><th>Date</th><th>Type</th><th>Amount</th><th>Commission</th><th>Status</th></tr></thead>
                        <tbody id="activityTable"><tr><td colspan="5" style="text-align: center; color: #999; padding: 40px;">No activity yet</td></tr></tbody>
                    </table>
                </div>
            </div>

            <div id="payouts" class="tab-content">
                <div class="alert alert-info"><strong>üí∏ Payouts via PayPal - Minimum: $25</strong></div>
                <div class="payout-card"><h3>Available Balance</h3><div class="payout-amount" id="payoutBalance">$0</div></div>
                <div class="form-group"><label>PayPal Email</label><input type="email" id="paypalEmail" placeholder="paypal@email.com"></div>
                <div class="form-group"><label>Amount</label><input type="number" id="withdrawAmount" min="25" step="0.01" placeholder="25.00"></div>
                <button class="btn btn-success" onclick="requestPayout()">Request Payout</button>
                <h3 style="margin-top: 40px;">History</h3>
                <div class="table-container">
                    <table class="data-table">
                        <thead><tr><th>Date</th><th>Amount</th><th>PayPal</th><th>Status</th></tr></thead>
                        <tbody id="payoutHistory"><tr><td colspan="4" style="text-align: center; color: #999; padding: 40px;">No payouts</td></tr></tbody>
                    </table>
                </div>
            </div>

            <div id="nonprofit" class="tab-content">
                <div class="alert alert-info"><strong>üéóÔ∏è Codes without commission tracking</strong></div>
                <div class="form-group"><label>Non-Profit Name</label><input type="text" id="nonprofitName" placeholder="Animal Shelter"></div>
                <div class="form-group"><label>Code Prefix</label><input type="text" id="nonprofitPrefix" placeholder="SHELTER" maxlength="10"></div>
                <div class="form-group"><label>Discount %</label><select id="nonprofitDiscount"><option value="10">10%</option><option value="15">15%</option><option value="20">20%</option><option value="25">25%</option></select></div>
                <div class="form-group"><label>Notes</label><textarea id="nonprofitNotes" rows="3"></textarea></div>
                <button class="btn btn-primary" onclick="generateNonprofitCode()">Generate Code</button>
                <div id="nonprofitResult"></div>
                <h3 style="margin-top: 40px;">Codes</h3>
                <div class="table-container">
                    <table class="data-table">
                        <thead><tr><th>Code</th><th>Name</th><th>Discount</th><th>Created</th><th>Uses</th></tr></thead>
                        <tbody id="nonprofitTable"><tr><td colspan="5" style="text-align: center; color: #999; padding: 40px;">No codes</td></tr></tbody>
                    </table>
                </div>
            </div>

            <div id="admin" class="tab-content">
                <div class="alert alert-warning"><strong>üîß Create codes & record sales</strong></div>
                <h3>Create Code</h3>
                <div class="form-group"><label>Email</label><input type="email" id="adminEmail" placeholder="user@email.com"></div>
                <div class="form-group"><label>Name</label><input type="text" id="adminName" placeholder="John Doe"></div>
                <div class="form-group"><label>Commission %</label><select id="adminCommission"><option value="5">5%</option><option value="10" selected>10%</option><option value="15">15%</option><option value="20">20%</option></select></div>
                <div class="form-group"><label>Customer Discount %</label><select id="adminDiscount"><option value="5">5%</option><option value="10" selected>10%</option><option value="15">15%</option><option value="20">20%</option></select></div>
                <button class="btn btn-primary" onclick="createReferralCode()">Create Code</button>
                <div id="adminResult"></div>
                <hr style="margin: 40px 0; border: none; border-top: 2px solid #e0e0e0;">
                <h3>Record Sale</h3>
                <div class="form-group"><label>Code</label><input type="text" id="manualCode" placeholder="REFER123"></div>
                <div class="form-group"><label>Amount $</label><input type="number" id="manualAmount" min="0" step="0.01" placeholder="100.00"></div>
                <div class="form-group"><label>Order #</label><input type="text" id="manualOrder" placeholder="#1234"></div>
                <button class="btn btn-success" onclick="recordManualSale()">Record Sale</button>
            </div>

            <!-- NEW: IntakeQ tab content -->
            <div id="intakeq" class="tab-content">
                <div class="alert alert-info">
                    <strong>üîí Secure workflow</strong><br>
                    Intake forms are sent inside IntakeQ. This dashboard does not store form answers.
                </div>

                <div class="code-section">
                    <h2>Open IntakeQ</h2>
                    <p style="margin-top: 10px; color: #555; line-height: 1.6;">
                        1) Click <strong>Open IntakeQ</strong> (opens in a new tab)<br>
                        2) Log into IntakeQ<br>
                        3) Click <strong>Send Form to Client</strong><br>
                        4) Send the email and close the IntakeQ tab
                    </p>

                    <div style="margin-top: 20px;">
                        <button class="btn btn-primary" onclick="openIntakeQ()">üîí Open IntakeQ</button>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    const CONFIG = {
        GOOGLE_SHEET_URL: 'https://script.google.com/macros/s/AKfycbx9n_F5jwPF879nU8-lNzIstkobP_nDVV-xWryPuDcmqnksXo6xMdo6DRPecZiwl-jj/exec',
        SHOPIFY_STORE_URL: 'https://caregivers-support-guide-2.myshopify.com',
        MIN_PAYOUT: 25,

        // NEW:
        INTAKEQ_URL: 'https://intakeq.com/signin'
    };

    let currentUser = null;

    function openIntakeQ() {
        window.open(CONFIG.INTAKEQ_URL, "_blank", "noopener,noreferrer");
    }

    async function login() {
        const email = document.getElementById('userEmail').value.trim();
        const code = document.getElementById('existingCode').value.trim().toUpperCase();
        if (!email || !validateEmail(email)) { alert('Please enter valid email'); return; }
        localStorage.setItem('referralEmail', email);
        try {
            let userData;
            if (code) {
                userData = await getReferralByCode(code);
                if (!userData) { alert('Code not found. Creating new!'); userData = await createNewReferral(email); }
            } else {
                userData = await getReferralByEmail(email);
                if (!userData) userData = await createNewReferral(email);
            }
            currentUser = userData;
            showDashboard();
            loadUserData();
        } catch (error) {
            console.error('Login error:', error);
            alert('Error: Check CONFIG URLs!');
        }
    }

    function showDashboard() {
        document.getElementById('loginSection').classList.add('hidden');
        document.getElementById('mainDashboard').classList.remove('hidden');
    }

    async function loadUserData() {
        if (!currentUser) return;
        document.getElementById('userCode').textContent = currentUser.code;
        document.getElementById('referralLink').value = `${CONFIG.SHOPIFY_STORE_URL}?discount=${currentUser.code}`;
        document.getElementById('customerDiscount').textContent = currentUser.discount + '%';
        document.getElementById('commissionRate').textContent = currentUser.commission + '%';
        try {
            const sales = await getSalesForReferral(currentUser.code);
            let totalSales = 0, totalEarned = 0, availableBalance = 0;
            sales.forEach(sale => {
                totalSales++;
                const commission = (sale.amount * currentUser.commission) / 100;
                totalEarned += commission;
                if (sale.status !== 'paid') availableBalance += commission;
            });
            document.getElementById('totalClicks').textContent = currentUser.clicks || 0;
            document.getElementById('totalSales').textContent = totalSales;
            document.getElementById('totalEarned').textContent = '$' + totalEarned.toFixed(2);
            document.getElementById('availableBalance').textContent = '$' + availableBalance.toFixed(2);
            document.getElementById('payoutBalance').textContent = '$' + availableBalance.toFixed(2);
            loadActivityTable(sales);
            loadPayoutHistory();
        } catch (error) {
            console.error('Error loading data:', error);
        }
    }

    function loadActivityTable(sales) {
        const tbody = document.getElementById('activityTable');
        if (sales.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999; padding: 40px;">No activity yet</td></tr>';
            return;
        }
        let html = '';
        sales.forEach(sale => {
            const commission = (sale.amount * currentUser.commission) / 100;
            html += `<tr><td>${new Date(sale.date).toLocaleDateString()}</td><td>Sale</td><td>$${sale.amount.toFixed(2)}</td><td>$${commission.toFixed(2)}</td><td><span class="status-badge ${sale.status === 'paid' ? 'status-paid' : 'status-pending'}">${sale.status}</span></td></tr>`;
        });
        tbody.innerHTML = html;
    }

    async function requestPayout() {
        const paypalEmail = document.getElementById('paypalEmail').value.trim();
        const amount = parseFloat(document.getElementById('withdrawAmount').value);
        if (!paypalEmail || !validateEmail(paypalEmail)) { alert('Enter valid PayPal email'); return; }
        if (!amount || amount < CONFIG.MIN_PAYOUT) { alert(`Minimum is $${CONFIG.MIN_PAYOUT}`); return; }
        const available = parseFloat(document.getElementById('payoutBalance').textContent.replace('$', ''));
        if (amount > available) { alert('Insufficient balance'); return; }
        if (confirm(`Request $${amount.toFixed(2)} to ${paypalEmail}?`)) {
            try {
                await createPayoutRequest(currentUser.email, paypalEmail, amount);
                alert('Payout requested!');
                loadUserData();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
    }

    async function loadPayoutHistory() {
        try {
            const payouts = await getPayoutsForUser(currentUser.email);
            const tbody = document.getElementById('payoutHistory');
            if (payouts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #999; padding: 40px;">No payouts</td></tr>';
                return;
            }
            let html = '';
            payouts.forEach(payout => {
                html += `<tr><td>${new Date(payout.date).toLocaleDateString()}</td><td>$${payout.amount.toFixed(2)}</td><td>${payout.paypalEmail}</td><td><span class="status-badge ${payout.status === 'paid' ? 'status-paid' : 'status-pending'}">${payout.status}</span></td></tr>`;
            });
            tbody.innerHTML = html;
        } catch (error) {
            console.error('Error loading payouts:', error);
        }
    }

    async function generateNonprofitCode() {
        const name = document.getElementById('nonprofitName').value.trim();
        const prefix = document.getElementById('nonprofitPrefix').value.trim().toUpperCase();
        const discount = document.getElementById('nonprofitDiscount').value;
        const notes = document.getElementById('nonprofitNotes').value.trim();
        if (!name) { alert('Enter name'); return; }
        try {
            const code = await createNonprofitCode(name, prefix, discount, notes);
            document.getElementById('nonprofitResult').innerHTML = `<div class="alert alert-success" style="margin-top: 20px;"><strong>‚úÖ Code: ${code}</strong><br>Discount: ${discount}%<br><br>Add to Shopify Discounts!</div>`;
            document.getElementById('nonprofitName').value = '';
            document.getElementById('nonprofitPrefix').value = '';
            document.getElementById('nonprofitNotes').value = '';
            loadNonprofitCodes();
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }

    async function loadNonprofitCodes() {
        try {
            const codes = await getAllNonprofitCodes();
            const tbody = document.getElementById('nonprofitTable');
            if (codes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999; padding: 40px;">No codes</td></tr>';
                return;
            }
            let html = '';
            codes.forEach(code => {
                html += `<tr><td><strong>${code.code}</strong></td><td>${code.name}</td><td>${code.discount}%</td><td>${new Date(code.created).toLocaleDateString()}</td><td>${code.uses || 0}</td></tr>`;
            });
            tbody.innerHTML = html;
        } catch (error) {
            console.error('Error loading codes:', error);
        }
    }

    async function createReferralCode() {
        const email = document.getElementById('adminEmail').value.trim();
        const name = document.getElementById('adminName').value.trim();
        const commission = document.getElementById('adminCommission').value;
        const discount = document.getElementById('adminDiscount').value;
        if (!email || !validateEmail(email)) { alert('Enter valid email'); return; }
        try {
            const referral = await createNewReferral(email, name, commission, discount);
            document.getElementById('adminResult').innerHTML = `<div class="alert alert-success" style="margin-top: 20px;"><strong>‚úÖ Code: ${referral.code}</strong><br>Email: ${email}<br>Commission: ${commission}%<br>Discount: ${discount}%<br><br>Add to Shopify!</div>`;
            document.getElementById('adminEmail').value = '';
            document.getElementById('adminName').value = '';
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }

    async function recordManualSale() {
        const code = document.getElementById('manualCode').value.trim().toUpperCase();
        const amount = parseFloat(document.getElementById('manualAmount').value);
        const orderNum = document.getElementById('manualOrder').value.trim();
        if (!code) { alert('Enter code'); return; }
        if (!amount || amount <= 0) { alert('Enter valid amount'); return; }
        try {
            await recordSale(code, amount, orderNum);
            alert('Sale recorded!');
            document.getElementById('manualCode').value = '';
            document.getElementById('manualAmount').value = '';
            document.getElementById('manualOrder').value = '';
            if (currentUser) loadUserData();
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }

    function copyCode() { navigator.clipboard.writeText(document.getElementById('userCode').textContent); alert('Code copied!'); }
    function copyLink() { navigator.clipboard.writeText(document.getElementById('referralLink').value); alert('Link copied!'); }

    function switchTab(event, tabName) {
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        event.target.classList.add('active');
        if (tabName === 'nonprofit') loadNonprofitCodes();
    }

    function validateEmail(email) { return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email); }

    function generateCode(prefix = '') {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let code = prefix;
        for (let i = 0; i < (8 - prefix.length); i++) code += chars.charAt(Math.floor(Math.random() * chars.length));
        return code;
    }

    async function makeRequest(action, data = {}) {
        const response = await fetch(CONFIG.GOOGLE_SHEET_URL, { method: 'POST', body: JSON.stringify({ action, ...data }) });
        return response.json();
    }

    async function getReferralByEmail(email) { const result = await makeRequest('getReferralByEmail', { email }); return result.data; }
    async function getReferralByCode(code) { const result = await makeRequest('getReferralByCode', { code }); return result.data; }
    async function createNewReferral(email, name = '', commission = 10, discount = 10) {
        const code = generateCode();
        const result = await makeRequest('createReferral', { email, name, code, commission: parseInt(commission), discount: parseInt(discount) });
        return result.data;
    }
    async function getSalesForReferral(code) { const result = await makeRequest('getSales', { code }); return result.data || []; }
    async function recordSale(code, amount, orderNum = '') { await makeRequest('recordSale', { code, amount, orderNum }); }
    async function getPayoutsForUser(email) { const result = await makeRequest('getPayouts', { email }); return result.data || []; }
    async function createPayoutRequest(email, paypalEmail, amount) { await makeRequest('createPayout', { email, paypalEmail, amount }); }
    async function createNonprofitCode(name, prefix, discount, notes) {
        const code = generateCode(prefix);
        await makeRequest('createNonprofit', { code, name, discount, notes });
        return code;
    }
    async function getAllNonprofitCodes() { const result = await makeRequest('getNonprofits'); return result.data || []; }
</script>
</body>
</html>
